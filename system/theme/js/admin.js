$&&$(function(){function e(e,t){var r=$("#e2-unsaved-note-prototype").clone(!0);r.attr("id",null),$(".e2-admin-link",r).attr("href",e),$("u",r).html(t),r.attr("style",""),o.append(r)}e2UploadFile=function(e,t,r,n,a){if(FormData){var o=new FormData;o.append("file",e),$.ajax({type:"POST",timeout:0,url:t,data:o,cache:!1,contentType:!1,processData:!1,xhr:function(){var e=$.ajaxSettings.xhr();return e.upload&&e.upload.addEventListener("progress",r,!1),e},success:n,error:a})}};var t=function(e,t,r,n){var a=r,o=n;return $(t).removeClass("e2-toggle-on"),$(t).addClass("e2-toggle-thinking"),$.ajax({type:"post",timeout:1e4,url:$(t).attr("href"),data:"result=ajaxresult",success:function(e){"on-rehref|"==e.substr(0,10)&&a(e.substr(10)),"off-rehref|"==e.substr(0,11)&&o(e.substr(11))},error:function(e){location.href=$(t).attr("href")},complete:function(e){$(t).removeClass("e2-toggle-thinking")}}),!1};if($(".e2-favourite-toggle").click(function(e){var r=this;return t(e,r,function(e){$(r).addClass("e2-toggle-on"),$(r).parent().parent().parent().addClass("e2-note-favourite"),$(r).attr("href",e)},function(e){$(r).removeClass("e2-toggle-on"),$(r).parent().parent().parent().removeClass("e2-note-favourite"),$(r).attr("href",e)})}),$(".e2-pinned-toggle").click(function(e){var r=this;return t(e,r,function(e){$(r).addClass("e2-toggle-on"),$(r).attr("href",e)},function(e){$(r).removeClass("e2-toggle-on"),$(r).attr("href",e)})}),$(".e2-important-toggle").click(function(e){var r=this;return t(e,r,function(e){$(r).addClass("e2-toggle-on"),$(r).parent().parent().parent().addClass("important"),$(r).attr("href",e),$ct=$(r).parents(".e2-comment-control-group").eq(0),$ct.find(".e2-markable").addClass("e2-marked"),document.$e2Mark&&document.$e2Mark()},function(e){$(r).removeClass("e2-toggle-on"),$(r).parent().parent().parent().removeClass("important"),$(r).attr("href",e),$ct=$(r).parents(".e2-comment-control-group").eq(0),$ct.find(".e2-markable").removeClass("e2-marked"),document.$e2Mark&&document.$e2Mark()})}),$(".e2-removed-toggle").click(function(e){var r=this,n=$(r).parents(".e2-comment").eq(0);return n.find(".e2-comment-actions").addClass("e2-disabled"),n.find(".e2-comment-actions-removed").addClass("e2-disabled"),t(e,r,function(e){$(r).addClass("e2-toggle-on"),n.find(".e2-comment-actions").removeClass("e2-disabled"),n.find(".e2-comment-actions-removed").hide(),n.find(".e2-comment-content").slideDown(333),n.find(".e2-comment-meta").slideDown(333),n.find(".e2-comment-author").removeClass("e2-comment-author-removed"),n.find(".e2-removed-toggle").attr("href",e),$(r).parents(".e2-comment").is(".e2-reply")||$(r).parents(".e2-comment-and-reply").find(".e2-reply").slideDown(333)},function(e){$(r).removeClass("e2-toggle-on"),n.find(".e2-comment-actions-removed").removeClass("e2-disabled"),n.find(".e2-comment-author").addClass("e2-comment-author-removed"),n.find(".e2-comment-meta").slideUp(333),n.find(".e2-comment-content").slideUp(333,function(){n.find(".e2-comment-actions-removed").show()}),n.find(".e2-removed-toggle").attr("href",e),$(r).parents(".e2-comment").is(".e2-reply")||$(r).parents(".e2-comment-and-reply").find(".e2-reply").slideUp(333)},function(e){return!1})}),e2DragEnter=function(e){if(dt=e.originalEvent.dataTransfer,dt&&(!dt.types.contains||dt.types.contains("Files"))&&(!dt.types.indexOf||dt.types.indexOf("Files")!=-1))return dt.dropEffect&&(dt.dropEffect="copy"),$(this).addClass("e2-external-drop-target-dragover"),$(this).hasClass("e2-external-drop-target-altable")&&e.altKey?$(this).addClass("e2-external-drop-target-dragover-alt"):$(this).removeClass("e2-external-drop-target-dragover-alt"),!1},e2DragLeave=function(){return $(this).removeClass("e2-external-drop-target-dragover"),$(this).removeClass("e2-external-drop-target-dragover-alt"),!1},$(".e2-external-drop-target").bind("dragover",e2DragEnter).bind("dragenter",e2DragEnter).bind("dragleave",e2DragLeave).bind("drop",e2DragLeave),e2ShowUploadProgressInArc=function(e,t){t=Math.min(t,1),fakeProgress=.1+.8*t;var r=245,n=Math.floor(r-fakeProgress*r);e.style.strokeDashoffset=n},$picContainer=$(".e2-user-picture-container"),$pic=$picContainer.find("img"),e2DropUserpic=function(e){if(dt=e.originalEvent.dataTransfer,dt||dt.files){var t=dt.files;return 1==t.length&&(file=t[0],$picContainer.addClass("e2-user-picture-container-uploading"),e2UploadFile(file,$("#e2-userpic-upload-action").attr("href"),function(e){e2ShowUploadProgressInArc($("#e2-user-picture-uploading #e2-progress")[0],e.loaded/e.total)},function(e,t,r){e2ShowUploadProgressInArc($("#e2-user-picture-uploading #e2-progress")[0],0),"image|"==e.substr(0,6)?(image=e.substr(6).split("|"),image=image[0],$pic.attr("src",image+"?"+escape(new Date)),$pic.bind("load",function(){$picContainer.removeClass("e2-user-picture-container-uploading")}),$(".e2-set-userpic-by-dragging").slideUp(333)):$picContainer.removeClass("e2-user-picture-container-uploading")},function(){e2ShowUploadProgressInArc($("#e2-user-picture-uploading #e2-progress")[0],0)})),!1}},$picContainer.bind("drop",e2DropUserpic),document.e2.isLocalStorageAvailable){var r=$("#e2-drafts-item"),n=$("#e2-drafts-item .e2-unsaved-led"),a=$("#e2-new-note-item .e2-unsaved-led"),o=$("#e2-notes-unsaved"),s=$("#e2-nothing-message"),i=$("#form-note"),d=document.e2.localCopies.getList(),l=Object.keys(d).length,c=document.e2.localCopies.doesCopyExist("new"),p=i?$("#note-id").val():null,m="new"!==p&&document.e2.localCopies.doesCopyExist(p);if(c&&l--,m&&l--,n&&l>0&&(r.show(),n.show()),a&&c&&a.show(),o&&s){var u=document.e2.localCopies.getName("new");d.hasOwnProperty(u)&&delete d[u];for(var f in d)"false"===d[f].isPublished&&($("#e2-draft-"+f+" .e2-unsaved-led").show(),delete d[f]);if(Object.keys(d).length){for(var f in d){var g=document.e2.localCopies.get(f);g&&e(g.link,g.title)}o.show(),s.hide()}}}});