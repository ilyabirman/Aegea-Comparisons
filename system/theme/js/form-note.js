$&&$(function(){function e(){document.e2.isLocalStorageAvailable&&(o?document.e2.localCopies.remove(o):document.e2.localCopies.remove($("#note-id").val()),document.e2.localCopies.destroyLocalSaver())}function t(){return{title:$("#title").val(),tags:($("#tags").val()||[]).join(),text:$("#text").val(),alias:$("#alias").val(),stamp:$("#stamp").val()}}function a(e,t){return JSON.stringify(e)===JSON.stringify(t)}var o=$("#note-id").val(),i=t(),r=i?Object.assign({},i):t(),n=($("#action").val(),!1),s=!1,l=!1,d=/^ *(\d{1,2})\.(\d{1,2})\.(\d{2}|\d{4}) +(\d{1,2})\:(\d{1,2})\:(\d{1,2}) *$/;$(window).bind("pageshow",function(e){e.originalEvent.persisted&&window.location.reload()}),document.e2.localCopies.initLocalSaver&&document.e2.localCopies.loadLocalCopy&&(document.e2.localCopies.loadLocalCopy(),document.e2.localCopies.initLocalSaver()),$.ajaxSetup({type:"post",timeout:1e4}),e2AjaxSave=function(t){t=t||{},$.ajax({data:$("form").serialize(),url:$("#e2-note-livesave-action").attr("href"),success:function(a){t.onAjaxSuccess&&t.onAjaxSuccess();try{ajaxresult=JSON.parse(a)}catch(i){return void(t.onError&&t.onError(i.message))}"created"==ajaxresult.status?(newdraftid=ajaxresult.id,history.replaceState&&(history.replaceState(null,"",ajaxresult["note-edit-url"]),$(".e2-admin-menu-new-selected").hide(),$(".e2-admin-menu-new").show()),$("#note-id").val(newdraftid),e(),t.onCreated&&t.onCreated(ajaxresult),o=null):"saved"==ajaxresult.status?($("#alias").val(ajaxresult["new-alias"]),history.replaceState&&history.replaceState(null,"",ajaxresult["note-edit-url"]),e(),t.onSaved&&t.onSaved(ajaxresult),o=null):"error"==ajaxresult.status&&t.onError&&t.onError(ajaxresult.message)},error:function(e){t.onAjaxError&&t.onAjaxError(e.responseText)},complete:function(e){t.onAjaxComplete&&t.onAjaxComplete()}})},e2UpdateSubmittability=function(){var e=!0;$("#stamp").val()&&d.test($("#stamp").val());var t=!/^ *$/.test($("#title").val())&&!/^ *$/.test($("#text").val())&&e&&!l;t?$("#submit-button").removeAttr("disabled"):$("#submit-button").attr("disabled","disabled")},e2LiveSaveError=function(e){$("#e2-console").html(e),$("#livesaving").hide(),$("#livesave-button, #livesave-button + .e2-unsaved-led").show(),$("#livesave-error").show(),$("#livesave-error").attr("title",e)},e2LiveSave=function(){if(!l){var e=t();if(""!=e.text){if(l=!0,e2UpdateSubmittability(),""==e.title){var a,o=e.text;(a=o.indexOf("."))>=0&&(o=o.substr(0,a)),(a=o.indexOf(";"))>=0&&(o=o.substr(0,a)),(a=o.indexOf(","))>=0&&(o=o.substr(0,a)),(a=o.indexOf(")"))>=0&&(o=o.substr(0,a)),0==o.indexOf("((")&&(o=o.substr(2)),o=o.substr(0,1).toUpperCase()+o.substr(1),$("#title").val(o).change()}$("#livesave-button, #livesave-button + .e2-unsaved-led, #livesave-error").hide(),$("#livesaving").fadeIn(333),e2AjaxSave({onCreated:function(){i=e,$("#e2-drafts")&&$("#e2-drafts-item")&&($("#e2-drafts-item").fadeIn(333),$('<div class="e2-menu-item-frame"></div>').css({position:"absolute",left:$("#e2-note-form-wrapper").offset().left,top:$("#e2-note-form-wrapper").offset().top,width:$("#e2-note-form-wrapper").width(),height:$("#e2-note-form-wrapper").height()}).appendTo("body").animate({left:$("#e2-drafts").offset().left-10,top:$("#e2-drafts").offset().top-5,width:$("#e2-drafts").width()+20,height:$("#e2-drafts").height()+10},667).fadeTo(333,.667).fadeOut(333),$("#e2-drafts-count").html(1*$("#e2-drafts-count").html()+1))},onSaved:function(){i=e},onError:e2LiveSaveError,onAjaxSuccess:function(){$("#livesaving").fadeOut(333)},onAjaxError:e2LiveSaveError,onAjaxComplete:function(){l=!1,e2UpdateSubmittability()}})}}},$("#form-note").on("submit",function(e){function a(e){i=r,$("#note-saving").hide(),$("#note-saved").fadeIn(333),location.href=e["note-url"]}function o(e){$("#form-note").trigger("ajaxError"),$("#note-saving").hide(),$("#submit-keyboard-shortcut").show(),$("#note-save-error").show(),$("#note-save-error").attr("title",e)}e.preventDefault();var r=t();l=!0,e2UpdateSubmittability(),$("#submit-keyboard-shortcut, #note-save-error").hide(),$("#note-saving").show(),e2AjaxSave({onCreated:a,onSaved:a,onError:o,onAjaxError:o,onAjaxComplete:function(){l=!1,e2UpdateSubmittability()}})}),$("#title").bind("input",function(){$("#alias").attr("placeholder","")});var u="change input keyup keydown keypress mouseup mousedown cut copy paste blur",v=function(){$("#stamp").val()&&$("#stamp").toggleClass("input-error",null===$("#stamp").val().match(d)),e2UpdateSubmittability();var o=t();n=!a(r,o),s=!i||!a(i,o);var l=$("#livesave-button, #livesave-button + .e2-unsaved-led");n&&s&&""!=o.text?(n=!1,$("#livesaving").hide(),document.e2.localCopies.initLocalSaver(),l.fadeIn(333),r=Object.assign({},o)):s||(s=!1,e(),l.fadeOut(333),r=Object.assign({},o));var u=o.title.trim(),v=o.text.trim(),c=$("#e2-uploaded-images .e2-uploaded-image-preview");c.length||u||v||!l.is(":visible")||l.fadeOut(333)};$("#title").add("#tags").add("#text").add("#alias").add("#stamp").bind(u,v),$("#tags").on("liszt:ready",function(){$("#tags_chzn .search-field").bind(u,v)}),$("#title").bind("keydown",function(e){13==e.keyCode&&$("#text").focus()}),$("#livesave-button").click(function(){return e2LiveSave(),!1}),$(document).bind("keydown keyup keypress",function(e){if(key=e.keyCode,key||(key=e.charCode),ctrl=document.e2.mac?e.metaKey&&!e.ctrlKey:e.ctrlKey,"keypress"==e.type){if(ctrl&&(115==key||1099==key))return e2LiveSave(),!1}else if(ctrl&&(83==key||1067==key))return e2LiveSave(),!1}),$("#text").is(":focus")||$("#title").attr("autofocus",!0).focus().val($("#title").val()),e2UpdateSubmittability()});