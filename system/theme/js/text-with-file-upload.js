$&&$(function(){var e=[],t=[],a=0,r=0;e2PastePic=function(e){if(alt="",text="","calliope"==$("#formatter-id").val()&&(text="(("+e+alt+"))"),"neasden"==$("#formatter-id").val()&&(text=e+alt),text){if(field=document.getElementById("text"),field.focus(),field.selectionStart||"0"==field.selectionStart){if(selStart=field.selectionStart,selEnd=field.selectionEnd,textToPaste=text,extraLength=0,selStart==selEnd){for(selStartBefore=selStart;"\r"!=field.value.charAt(selStart)&&"\n"!=field.value.charAt(selStart)&&selStart>0;)selStart-=1;for(;"\r"==field.value.charAt(selStart)||"\n"==field.value.charAt(selStart);)selStart+=1;textToPaste+="\n\n",selEnd=selStart}field.value=field.value.substring(0,selStart)+textToPaste+field.value.substring(selEnd,field.value.length),field.selectionStart=field.selectionEnd=selStart+textToPaste.length-2}else field.value+="\r\n\r\n"+text;if("createEvent"in document){var t=document.createEvent("HTMLEvents");t.initEvent("change",!1,!0),field.dispatchEvent(t)}else field.fireEvent("onchange");field.focus()}},$e2AddPasteableImage=function(e,a,r,i){return $newImage=$("#e2-uploaded-image-prototype").clone(!0),$newImage.attr("style",""),$newImage.css("width",""),$newImage.find(".e2-uploaded-image-preview img").attr("src",e+"?"+(new Date).getTime()).attr("alt",a).attr("width",r).attr("height",i),$newImage.find(".e2-uploaded-image-remover").data("file",a),t.push(a),$newImage},$("#e2-uploaded-image-prototype").click(function(){e2PastePic($(this).find(".e2-uploaded-image-preview img").attr("alt"))}),e2Delfiles=function(e,a){$.ajax({data:e,timeout:6e4,url:$("#e2-file-remove-action").attr("href"),success:function(r){"error|"==r.substr(0,6)?a.fadeTo(333,1):(t.splice($.inArray(e.file,t),1),a.hide(333,function(){$(this).remove()}))},error:function(e){a.fadeTo(333,1)}})},$(".e2-uploaded-image-remover").click(function(){var e=$(this).parent().parent();return e.fadeTo(333,.5),e2Delfiles({file:$(this).data("file")},e),!1}),$("#e2-uploaded-images").children().each(function(){var e=$(this).find(".e2-uploaded-image-preview img"),t=e.attr("src"),a=e.attr("alt"),r=e.attr("width"),i=e.attr("height");$(this).remove(),$e2AddPasteableImage(t,a,r,i).appendTo($("#e2-uploaded-images")).show()});var o=function(e){return ext="",(dot=e.lastIndexOf("."))!=-1&&(ext=e.substr(dot+1)),$(".e2-upload-error").slideUp(333),/^gif|jpe?g|png|svg|mp3$/i.test(ext)?($("#e2-uploading").show().css("opacity",1),$("#e2-upload-button").hide(),!0):($("#e2-upload-error-unsupported-file").slideDown(333),!1)},l=function(e,r,i){if(r=JSON.parse(r),r.success)if(a+=e.size,r.overwrite){$("#e2-uploading").hide(),$("#e2-upload-button").show();var o=$('#e2-uploaded-images img[src="'+r.thumb+'"], #e2-uploaded-images img[src^="'+r.thumb+'?"]')[0];o&&(o.src=r.thumb+"?"+(new Date).getTime())}else{i&&e2PastePic(r["new-name"]);var l=$.inArray(r["new-name"],t)!==-1;l?($("#e2-uploading").hide(),$("#e2-upload-button").show()):$e2AddPasteableImage(r.thumb,r["new-name"],r.width,r.height).appendTo($("#e2-uploaded-images")).show(333,function(){$("#e2-uploading").hide(),$("#e2-upload-button").show()})}else $("#e2-uploading").hide(),$("#e2-upload-button").show(),"could-not-create-thumbnail"==r.error?$("#e2-upload-error-cannot-create-thumbnail").slideDown(333):$("#e2-upload-error-cannot-upload").slideDown(333);e2ClearUploadBuffer()};new AjaxUpload("e2-upload-button",{action:$("#e2-file-upload-action").attr("href"),autoSubmit:!0,onSubmit:o,onComplete:l}),$("#e2-upload-controls").show(),e2ClearUploadBuffer=function(){if(e.length){var t=e.shift(),i=t.name,n=$("#e2-file-upload-action").attr("href");return t.e2AltKeyPressed&&(n+="&overwrite"),o(i)&&e2UploadFile(t,n,function(e){e2ShowUploadProgressInArc($("#e2-uploading #e2-progress")[0],(a+e.loaded)/r)},function(e,a,r){e2ShowUploadProgressInArc($("#e2-uploading #e2-progress")[0],0),l(t,e,t.e2DroppedIntoTextarea)},function(e,a,r){e2ShowUploadProgressInArc($("#e2-uploading #e2-progress")[0],0),l(null,'{"success": false}',t.e2DroppedIntoTextarea)}),!1}return r=0,a=0,!0},e2DropPictures=function(t){var o=t.originalEvent.dataTransfer;if(o&&o.files){for(i=0;i<o.files.length;i++)o.files[i].e2AltKeyPressed=t.altKey,o.files[i].e2DroppedIntoTextarea=t.target==document.getElementById("text"),e.push(o.files[i]),a=0,r+=o.files[i].size;return e2ClearUploadBuffer(),!1}},$(".e2-external-drop-target-body").bind("drop",e2DropPictures),$(".e2-external-drop-target-textarea").bind("drop",e2DropPictures)});